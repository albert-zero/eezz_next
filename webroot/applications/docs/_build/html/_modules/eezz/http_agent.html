

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>eezz.http_agent &mdash; EEZZ 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            EEZZ
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">eezz</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">EEZZ</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">eezz.http_agent</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for eezz.http_agent</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd"> his module implements the following classes</span>

<span class="sd">    * :py:class:`eezz.http_agent.THttpAgent`:  The handler for incoming WEB-socket requests</span>

<span class="sd">    The interaction with the JavaScript via WEB-Socket includes generation of HTML parts for user interface updates.</span>
<span class="sd">    It inherits from abstract eezz.websocket.TWebSocketAgent and implements the method &quot;handle_request&quot;</span>
<span class="sd">    The class provides methods to compile EEZZ extensions and to generate complex DOM structures.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span>  <span class="nn">io</span>
<span class="kn">import</span>  <span class="nn">json</span>
<span class="kn">import</span>  <span class="nn">uuid</span>
<span class="kn">import</span>  <span class="nn">copy</span>
<span class="kn">from</span>    <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">from</span> <span class="nn">pathlib</span>   <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span>    <span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">bs4</span>       <span class="kn">import</span> <span class="n">Tag</span><span class="p">,</span> <span class="n">BeautifulSoup</span><span class="p">,</span> <span class="n">NavigableString</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span><span class="p">,</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">table</span>     <span class="kn">import</span> <span class="n">TTable</span><span class="p">,</span> <span class="n">TTableCell</span><span class="p">,</span> <span class="n">TTableRow</span>
<span class="kn">from</span> <span class="nn">websocket</span> <span class="kn">import</span> <span class="n">TWebSocketAgent</span>
<span class="kn">from</span> <span class="nn">service</span>   <span class="kn">import</span> <span class="n">TService</span><span class="p">,</span> <span class="n">TServiceCompiler</span><span class="p">,</span> <span class="n">TTranslate</span>
<span class="kn">from</span> <span class="nn">lark</span>      <span class="kn">import</span> <span class="n">Lark</span><span class="p">,</span> <span class="n">UnexpectedCharacters</span><span class="p">,</span> <span class="n">Tree</span><span class="p">,</span> <span class="n">UnexpectedEOF</span>
<span class="kn">from</span> <span class="nn">loguru</span>    <span class="kn">import</span> <span class="n">logger</span>


<div class="viewcode-block" id="THttpAgent">
<a class="viewcode-back" href="../../eezz.html#eezz.http_agent.THttpAgent">[docs]</a>
<span class="k">class</span> <span class="nc">THttpAgent</span><span class="p">(</span><span class="n">TWebSocketAgent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Agent handles WEB socket events &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soup</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="THttpAgent.handle_request">
<a class="viewcode-back" href="../../eezz.html#eezz.http_agent.THttpAgent.handle_request">[docs]</a>
    <span class="nd">@logger</span><span class="o">.</span><span class="n">catch</span>
    <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Handle WEB socket requests</span>

<span class="sd">        * **initialize**: The browser sends the complete HTML for analysis.</span>
<span class="sd">        * **call**: The request issues a method call and the result is sent back to the browser</span>

<span class="sd">        :param dict request_data:   The request send by the browser</span>
<span class="sd">        :return: Response in JSON stream, containing valid HTML parts for the browser</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_updates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">x_tasks</span>   <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">x_result</span>  <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;initialize&#39;</span> <span class="ow">in</span> <span class="n">request_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">soup</span>   <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">request_data</span><span class="p">[</span><span class="s1">&#39;initialize&#39;</span><span class="p">],</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">,</span> <span class="n">multi_valued_attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">soup</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;table[data-eezz-compiled]&#39;</span><span class="p">):</span>
                <span class="n">x_html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_html_table</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                <span class="n">x_id</span>   <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data-eezz-json&#39;</span><span class="p">):</span>
                    <span class="n">x_gen_request</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;call&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="s1">&#39;get_header_row&#39;</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">x_id</span><span class="p">}}</span>
                    <span class="n">x_gen_request</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;data-eezz-json&#39;</span><span class="p">]))</span>
                    <span class="n">x_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x_id</span><span class="p">,</span> <span class="n">x_gen_request</span><span class="p">))</span>

                <span class="n">x_updates</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x_id</span><span class="si">}</span><span class="s1">.caption.innerHTML&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">x_html</span><span class="p">[</span><span class="s1">&#39;caption&#39;</span><span class="p">]})</span>
                <span class="n">x_updates</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x_id</span><span class="si">}</span><span class="s1">.thead.innerHTML&#39;</span><span class="p">,</span>   <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">x_html</span><span class="p">[</span><span class="s1">&#39;thead&#39;</span><span class="p">]})</span>
                <span class="n">x_updates</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x_id</span><span class="si">}</span><span class="s1">.tbody.innerHTML&#39;</span><span class="p">,</span>   <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">x_html</span><span class="p">[</span><span class="s1">&#39;tbody&#39;</span><span class="p">]})</span>
                <span class="n">x_updates</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x_id</span><span class="si">}</span><span class="s1">.tfoot.innerHTML&#39;</span><span class="p">,</span>   <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">x_html</span><span class="p">[</span><span class="s1">&#39;tfoot&#39;</span><span class="p">]})</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>  <span class="bp">self</span><span class="o">.</span><span class="n">soup</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;.clzz_grid[data-eezz-compiled]&#39;</span><span class="p">):</span>
                <span class="n">x_html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_html_grid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">x_id</span>   <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="n">x_updates</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x_id</span><span class="si">}</span><span class="s1">.innerHTML&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">x_html</span><span class="p">[</span><span class="s1">&#39;tbody&#39;</span><span class="p">]})</span>

                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data-eezz-json&#39;</span><span class="p">):</span>
                    <span class="n">x_gen_request</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;call&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="s1">&#39;get_header_row&#39;</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">x_id</span><span class="p">}}</span>
                    <span class="n">x_gen_request</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;data-eezz-json&#39;</span><span class="p">]))</span>
                    <span class="n">x_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x_id</span><span class="p">,</span> <span class="n">x_gen_request</span><span class="p">))</span>

            <span class="c1"># manage translation if service started with command line option --translate:</span>
            <span class="k">if</span> <span class="n">TService</span><span class="p">()</span><span class="o">.</span><span class="n">translate</span><span class="p">:</span>
                <span class="n">x_translate</span> <span class="o">=</span> <span class="n">TTranslate</span><span class="p">()</span>
                <span class="n">x_translate</span><span class="o">.</span><span class="n">generate_pot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">soup</span><span class="p">,</span> <span class="n">request_data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
            <span class="n">x_result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;update&#39;</span><span class="p">:</span> <span class="n">x_updates</span><span class="p">,</span> <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="n">x_tasks</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">x_result</span>

        <span class="c1"># A call request consists of a method to call and a set ot tags to update (updates might be an empty list)</span>
        <span class="c1"># The update is a list of key-value pairs separated by a colon</span>
        <span class="c1"># The key is the html-element-id and the attribute separated by dot</span>
        <span class="c1"># The value is a valid HTML string to replace either the attribute value or part of the element (for example table.body)</span>
        <span class="k">if</span> <span class="s1">&#39;call&#39;</span> <span class="ow">in</span> <span class="n">request_data</span> <span class="ow">or</span> <span class="s1">&#39;update&#39;</span> <span class="ow">in</span> <span class="n">request_data</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Only interested in the x_tag object, which is stored as key(object, method-name) in the TService database</span>
                <span class="c1"># The method itself is executed in module TWebSocketClient</span>
                <span class="n">x_event</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">x_event</span><span class="p">:</span>
                    <span class="n">x_event</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">)</span>
                    <span class="n">x_keys</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x_event</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">x_event</span> <span class="o">=</span> <span class="n">x_event</span><span class="p">[</span><span class="n">x_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

                <span class="n">x_event_id</span>  <span class="o">=</span> <span class="n">x_event</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="n">x_row</span>       <span class="o">=</span> <span class="n">request_data</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>

                <span class="c1"># x_obj, x_method, x_tag, x_descr  = TService().get_method(x_event_id, x_event[&#39;function&#39;])</span>
                <span class="n">x_tag</span><span class="p">,</span> <span class="n">x_descr</span> <span class="o">=</span> <span class="n">TService</span><span class="p">()</span><span class="o">.</span><span class="n">get_tag_ref</span><span class="p">(</span><span class="n">x_event_id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">x_key</span><span class="p">,</span> <span class="n">x_value</span> <span class="ow">in</span> <span class="n">request_data</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">x_sub_keys</span> <span class="o">=</span> <span class="n">x_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">x_key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;this&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;tbody&#39;</span> <span class="ow">in</span> <span class="n">x_sub_keys</span><span class="p">:</span>
                        <span class="n">x_html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_html_table</span><span class="p">(</span><span class="n">x_tag</span><span class="p">,</span> <span class="n">x_event_id</span><span class="p">)</span>
                        <span class="n">x_updates</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x_event_id</span><span class="si">}</span><span class="s1">.tbody.innerHTML&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">x_html</span><span class="p">[</span><span class="s1">&#39;tbody&#39;</span><span class="p">]})</span>
                    <span class="k">elif</span> <span class="s1">&#39;tbody&#39;</span> <span class="ow">in</span> <span class="n">x_sub_keys</span><span class="p">:</span>
                        <span class="n">x_table_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">x_sub_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">x_html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_html_table</span><span class="p">(</span><span class="n">x_table_tag</span><span class="p">,</span> <span class="n">x_sub_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">x_updates</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x_sub_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">.tbody.innerHTML&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">x_html</span><span class="p">[</span><span class="s1">&#39;tbody&#39;</span><span class="p">]})</span>
                    <span class="k">elif</span> <span class="n">x_key</span> <span class="o">==</span> <span class="s1">&#39;this.subtree&#39;</span><span class="p">:</span>
                        <span class="n">x_id</span>            <span class="o">=</span> <span class="n">x_row</span><span class="o">.</span><span class="n">id</span>
                        <span class="n">x_table</span><span class="p">:</span> <span class="n">TTable</span> <span class="o">=</span> <span class="n">x_row</span><span class="o">.</span><span class="n">child</span>
                        <span class="n">x_target</span>        <span class="o">=</span> <span class="n">x_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">x_target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;this&#39;</span><span class="p">:</span>
                            <span class="n">x_tag</span><span class="p">:</span> <span class="n">Tag</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">x_target</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">x_tag</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;target for subtree not found (ignored): </span><span class="si">{</span><span class="n">x_target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="k">continue</span>

                        <span class="k">if</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;table&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">x_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="c1"># There is no subtree: Send empty value to collapse the tree view</span>
                                <span class="n">x_updates</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x_id</span><span class="si">}</span><span class="s1">.subtree&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">})</span>
                                <span class="k">continue</span>

                            <span class="c1"># Send a subtree template and data</span>
                            <span class="n">TService</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">x_id</span><span class="p">:</span> <span class="p">(</span><span class="n">x_table</span><span class="p">,</span> <span class="n">x_tag</span><span class="p">,</span> <span class="n">x_descr</span><span class="p">)})</span>
                            <span class="n">x_tag_list</span> <span class="o">=</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;tr[data-eezz-json]&#39;</span><span class="p">)</span>

                            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_tag_list</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;call&#39;</span><span class="p">):</span>
                                    <span class="n">x</span><span class="p">[</span><span class="s1">&#39;call&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_id</span>

                            <span class="n">x_html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_html_table</span><span class="p">(</span><span class="n">x_tag</span><span class="p">,</span> <span class="n">x_id</span><span class="p">)</span>
                            <span class="n">x_id</span>   <span class="o">=</span> <span class="n">x_row</span><span class="o">.</span><span class="n">id</span>
                            <span class="n">x_updates</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x_id</span><span class="si">}</span><span class="s1">.subtree&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="n">x_value</span><span class="p">,</span> <span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="n">x_html</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">],</span> <span class="s1">&#39;thead&#39;</span><span class="p">:</span> <span class="n">x_html</span><span class="p">[</span><span class="s1">&#39;thead&#39;</span><span class="p">],</span> <span class="s1">&#39;tbody&#39;</span><span class="p">:</span> <span class="n">x_html</span><span class="p">[</span><span class="s1">&#39;tbody&#39;</span><span class="p">],</span> <span class="s1">&#39;tfoot&#39;</span><span class="p">:</span> <span class="n">x_html</span><span class="p">[</span><span class="s1">&#39;tfoot&#39;</span><span class="p">]}})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tag_row_template</span> <span class="o">=</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">soup</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;[data-eezz-template=row]&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">x_subtree_view</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_html_grid_item</span><span class="p">(</span><span class="n">tag_row_template</span><span class="p">,</span> <span class="n">x_row</span><span class="p">,</span> <span class="n">x_table</span><span class="p">)</span>
                            <span class="n">x_updates</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x_value</span><span class="si">}</span><span class="s1">.innerHTML&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;tbody&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x_subtree_view</span><span class="p">)}})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">request_data</span><span class="p">[</span><span class="s1">&#39;result-value&#39;</span><span class="p">]:</span>
                            <span class="n">x_updates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;KeyError </span><span class="si">{</span><span class="n">ex</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">x_result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;update&#39;</span><span class="p">:</span> <span class="n">x_updates</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">x_result</span></div>


<div class="viewcode-block" id="THttpAgent.do_get">
<a class="viewcode-back" href="../../eezz.html#eezz.http_agent.THttpAgent.do_get">[docs]</a>
    <span class="k">def</span> <span class="nf">do_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a_resource</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">a_query</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Response to an HTML GET command</span>

<span class="sd">        The agent reads the source, compiles the data-eezz sections and adds the web-socket component</span>
<span class="sd">        It returns the enriched document</span>

<span class="sd">        :param pathlib.Path a_resource: The path to the HTML document, containing EEZZ extensions</span>
<span class="sd">        :param dict         a_query:    The query string of the URL</span>
<span class="sd">        :return: The compiled version of the HTML file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_html</span>    <span class="o">=</span> <span class="n">a_resource</span>
        <span class="n">x_service</span> <span class="o">=</span> <span class="n">TService</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_resource</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">a_resource</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">x_html</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">x_parser</span>     <span class="o">=</span> <span class="n">Lark</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">x_service</span><span class="o">.</span><span class="n">resource_path</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;eezz.lark&#39;</span><span class="p">))</span>
        <span class="n">x_soup</span>       <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">x_html</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">,</span> <span class="n">multi_valued_attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># The template table is used to add missing structures as default</span>
        <span class="n">x_templ_path</span> <span class="o">=</span> <span class="n">x_service</span><span class="o">.</span><span class="n">resource_path</span> <span class="o">/</span> <span class="s1">&#39;template.html&#39;</span>
        <span class="k">with</span> <span class="n">x_templ_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">x_template</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">,</span> <span class="n">multi_valued_attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">x_templ_table</span> <span class="o">=</span> <span class="n">x_template</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">table</span>
        <span class="k">for</span> <span class="n">x_chrom</span> <span class="ow">in</span> <span class="n">x_soup</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;table[data-eezz]&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">x_chrom</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;caption&#39;</span><span class="p">):</span>
                <span class="n">x_chrom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">x_templ_table</span><span class="o">.</span><span class="n">caption</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">x_chrom</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;thead&#39;</span><span class="p">):</span>
                <span class="n">x_chrom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">x_templ_table</span><span class="o">.</span><span class="n">thead</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">x_chrom</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;tbody&#39;</span><span class="p">):</span>
                <span class="n">x_chrom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">x_templ_table</span><span class="o">.</span><span class="n">tbody</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">x_chrom</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;tfoot&#39;</span><span class="p">):</span>
                <span class="n">x_chrom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">x_templ_table</span><span class="o">.</span><span class="n">tfoot</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">x_chrom</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">):</span>
                <span class="n">x_chrom</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">())[:</span><span class="mi">8</span><span class="p">]</span>
            <span class="c1"># Compile subtree using the current table id for events</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compile_data</span><span class="p">(</span><span class="n">x_parser</span><span class="p">,</span> <span class="n">x_chrom</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;[data-eezz]&#39;</span><span class="p">),</span> <span class="n">x_chrom</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">x_chrom</span> <span class="ow">in</span> <span class="n">x_soup</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;select[data-eezz], .clzz_grid[data-eezz]&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">x_chrom</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">):</span>
                <span class="n">x_chrom</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">())[:</span><span class="mi">8</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compile_data</span><span class="p">(</span><span class="n">x_parser</span><span class="p">,</span> <span class="n">x_chrom</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;[data-eezz]&#39;</span><span class="p">),</span> <span class="n">x_chrom</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>

        <span class="c1"># Compiling the reset of the document</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compile_data</span><span class="p">(</span><span class="n">x_parser</span><span class="p">,</span> <span class="n">x_soup</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;[data-eezz]&#39;</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">a_query</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_soup</span><span class="o">.</span><span class="n">prettify</span><span class="p">()</span></div>


<div class="viewcode-block" id="THttpAgent.compile_data">
<a class="viewcode-back" href="../../eezz.html#eezz.http_agent.THttpAgent.compile_data">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">compile_data</span><span class="p">(</span><span class="n">a_parser</span><span class="p">:</span> <span class="n">Lark</span><span class="p">,</span> <span class="n">a_tag_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">a_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">a_query</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compile data-eezz-json to data-eezz-compile,</span>
<span class="sd">        create tag attributes and generate tag-id to manage incoming requests</span>

<span class="sd">        :param Lark a_parser:   The Lark parser to compile EEZZ to json</span>
<span class="sd">        :param list a_tag_list: HTML-Tag to compile</span>
<span class="sd">        :param str  a_id:       The ID of the tag to be identified for update</span>
<span class="sd">        :param dict a_query:    The query of the HTML request</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># logger.debug(f&#39;compile data \n{a_tag_list[0].prettify()}&#39;)</span>
        <span class="n">x_service</span> <span class="o">=</span> <span class="n">TService</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x_tag</span> <span class="ow">in</span> <span class="n">a_tag_list</span><span class="p">:</span>
            <span class="n">x_id</span>   <span class="o">=</span> <span class="n">a_id</span>
            <span class="c1"># --- get instead of pop</span>
            <span class="n">x_data</span> <span class="o">=</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data-eezz&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">x_data</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">x_id</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">):</span>
                        <span class="n">x_id</span> <span class="o">=</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data-eezz-compiled&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ok&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">x_syntax_tree</span> <span class="o">=</span> <span class="n">a_parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">x_data</span><span class="p">)</span>
                <span class="n">x_transformer</span> <span class="o">=</span> <span class="n">TServiceCompiler</span><span class="p">(</span><span class="n">x_tag</span><span class="p">,</span> <span class="n">x_id</span><span class="p">,</span> <span class="n">a_query</span><span class="p">)</span>
                <span class="n">x_tree</span>        <span class="o">=</span> <span class="n">x_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x_syntax_tree</span><span class="p">)</span>
                <span class="n">x_json</span>        <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">x_list_items</span>  <span class="o">=</span> <span class="n">x_tree</span><span class="o">.</span><span class="n">children</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_tree</span><span class="p">,</span> <span class="n">Tree</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">x_tree</span><span class="p">]</span>
                <span class="n">x_tag</span><span class="p">[</span><span class="s1">&#39;data-eezz-compiled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ok&quot;</span>

                <span class="k">for</span> <span class="n">x_part</span> <span class="ow">in</span> <span class="n">x_list_items</span><span class="p">:</span>
                    <span class="n">x_part_json</span> <span class="o">=</span> <span class="p">{</span><span class="n">x_part_key</span><span class="p">:</span> <span class="n">x_part_val</span> <span class="k">for</span> <span class="n">x_part_key</span><span class="p">,</span> <span class="n">x_part_val</span> <span class="ow">in</span> <span class="n">x_part</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">x_part_key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">,</span> <span class="s1">&#39;onload&#39;</span><span class="p">)}</span>
                    <span class="n">x_json</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x_part_json</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">x_json</span><span class="p">:</span>
                    <span class="n">x_tag</span><span class="p">[</span><span class="s1">&#39;data-eezz-json&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">x_json</span><span class="p">)</span>

                <span class="c1"># logger.debug(f&#39;{x_data} ==&gt; {x_list_items}&#39;)</span>
                <span class="k">if</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s1">&#39;data-eezz-template&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x_tag</span><span class="p">[</span><span class="s1">&#39;data-eezz-template&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;websocket&#39;</span><span class="p">:</span>
                    <span class="n">x_path</span>      <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">x_service</span><span class="o">.</span><span class="n">resource_path</span> <span class="o">/</span> <span class="s1">&#39;websocket.js&#39;</span><span class="p">)</span>
                    <span class="n">x_ws_descr</span>  <span class="o">=</span> <span class="s2">&quot;&quot;&quot;var g_eezz_socket_addr = &quot;ws://</span><span class="si">{host}</span><span class="s2">:</span><span class="si">{port}</span><span class="s2">&quot;;</span><span class="se">\n</span><span class="s2"> &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">TService</span><span class="p">()</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">TService</span><span class="p">()</span><span class="o">.</span><span class="n">websocket_addr</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">x_ws_descr</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;var g_eezz_arguments   = &quot;</span><span class="si">{args}</span><span class="s2">&quot;;</span><span class="se">\n</span><span class="s2"> &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">x_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">x_ws_descr</span> <span class="o">+=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">x_tag</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">x_ws_descr</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">UnexpectedCharacters</span><span class="p">,</span>  <span class="n">UnexpectedEOF</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="si">}</span><span class="s1">  position = </span><span class="si">{</span><span class="n">ex</span><span class="o">.</span><span class="n">pos_in_stream</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">x_data</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span></div>


<div class="viewcode-block" id="THttpAgent.format_attributes">
<a class="viewcode-back" href="../../eezz.html#eezz.http_agent.THttpAgent.format_attributes">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">format_attributes</span><span class="p">(</span><span class="n">a_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">a_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">a_fmt_funct</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">a_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Eval template tag-attributes, diving deep into data-eezz-json</span>

<span class="sd">        :param str a_id:        The ID which replaces the placeholder &#39;this&#39;</span>
<span class="sd">        :param str a_key:       Thw key string to pick the items in an HTML tag</span>
<span class="sd">        :param str a_value:     The dictionary in string format to be formatted</span>
<span class="sd">        :param Callable a_fmt_funct: The function to be called to format the values</span>
<span class="sd">        :return: The formatted string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">a_key</span> <span class="o">==</span> <span class="s1">&#39;data-eezz-json&#39;</span><span class="p">:</span>
            <span class="n">x_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">a_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;call&#39;</span> <span class="ow">in</span> <span class="n">x_json</span><span class="p">:</span>
                <span class="n">x_args</span> <span class="o">=</span> <span class="n">x_json</span><span class="p">[</span><span class="s1">&#39;call&#39;</span><span class="p">][</span><span class="s1">&#39;args&#39;</span><span class="p">]</span>
                <span class="n">x_json</span><span class="p">[</span><span class="s1">&#39;call&#39;</span><span class="p">][</span><span class="s1">&#39;args&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">x_key</span><span class="p">:</span> <span class="n">a_fmt_funct</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_key</span><span class="p">,</span> <span class="n">x_val</span> <span class="ow">in</span> <span class="n">x_args</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="k">if</span> <span class="n">a_id</span><span class="p">:</span>
                    <span class="n">x_json</span><span class="p">[</span><span class="s1">&#39;call&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_id</span>
            <span class="n">x_fmt_val</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">x_json</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_fmt_val</span> <span class="o">=</span> <span class="n">a_fmt_funct</span><span class="p">(</span><span class="n">a_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_fmt_val</span></div>


<div class="viewcode-block" id="THttpAgent.format_attributes_update">
<a class="viewcode-back" href="../../eezz.html#eezz.http_agent.THttpAgent.format_attributes_update">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">format_attributes_update</span><span class="p">(</span><span class="n">json_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">formatter</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Special routine to format function arguments in the update section</span>

<span class="sd">        :param Callable formatter:  Format function for values in curly brackets</span>
<span class="sd">        :param str json_str:        An eezz generated json string</span>
<span class="sd">        :return: formatted function arguments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_json_obj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
        <span class="n">x_update</span>   <span class="o">=</span> <span class="n">x_json_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="n">x_json_obj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;onload&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">x_update</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json_str</span>

        <span class="k">for</span> <span class="n">x_key</span><span class="p">,</span> <span class="n">x_val</span> <span class="ow">in</span> <span class="n">x_update</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">x_update</span><span class="p">[</span><span class="n">x_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatter</span><span class="p">(</span><span class="n">x_val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x_args</span> <span class="o">:=</span> <span class="n">x_val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">xx_key</span><span class="p">,</span> <span class="n">xx_value</span> <span class="ow">in</span> <span class="n">x_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">x_args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">xx_key</span><span class="p">:</span> <span class="n">formatter</span><span class="p">(</span><span class="n">xx_value</span><span class="p">)})</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">x_json_obj</span><span class="p">)</span></div>


<div class="viewcode-block" id="THttpAgent.generate_html_cells">
<a class="viewcode-back" href="../../eezz.html#eezz.http_agent.THttpAgent.generate_html_cells">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_html_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a_tag</span><span class="p">:</span> <span class="n">Tag</span><span class="p">,</span> <span class="n">a_cell</span><span class="p">:</span> <span class="n">TTableCell</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tag</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generate HTML cells</span>

<span class="sd">        :param   bs4.Tag a_tag:     The template tag to generate a table cell</span>
<span class="sd">        :param   TTableCell a_cell: The cell providing the data for the HTML tag element</span>
<span class="sd">        :return: A new tag, based on the template and the cell data</span>
<span class="sd">        :rtype:  bs4.Tag</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_fmt_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_attributes</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">a_cell</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">a_tag</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">x_new_tag</span>   <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">a_tag</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_new_tag</span><span class="o">.</span><span class="n">descendants</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Tag</span><span class="p">):</span>
                <span class="n">x</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">a_cell</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x_new_tag</span><span class="o">.</span><span class="n">string</span><span class="p">:</span>
            <span class="n">x_new_tag</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">a_tag</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">a_cell</span><span class="p">)</span>
        <span class="n">x_new_tag</span><span class="o">.</span><span class="n">attrs</span>  <span class="o">=</span> <span class="n">x_fmt_attrs</span>

        <span class="c1"># store the date-time in attribute, so it could be used for in-place formatting:</span>
        <span class="k">if</span> <span class="n">a_cell</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">):</span>
            <span class="n">x_new_tag</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">a_cell</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">x_new_tag</span></div>


<div class="viewcode-block" id="THttpAgent.generate_html_rows">
<a class="viewcode-back" href="../../eezz.html#eezz.http_agent.THttpAgent.generate_html_rows">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_html_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a_html_cells</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">a_tag</span><span class="p">:</span> <span class="n">Tag</span><span class="p">,</span> <span class="n">a_row</span><span class="p">:</span> <span class="n">TTableRow</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tag</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; This operation add fixed cells to the table.</span>
<span class="sd">        Cells which are not included as template for table data are used to add a constant info to the row</span>

<span class="sd">        :param list      a_html_cells:  A list of cells to build up a row</span>
<span class="sd">        :param bs4.Tag   a_tag:         The parent containing the templates for the row</span>
<span class="sd">        :param TTableRow a_row:         The table row values to insert</span>
<span class="sd">        :return: The row with values rendered to HTML</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_fmt_attrs</span>  <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_attributes</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">a_row</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">a_tag</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">x_html_cells</span> <span class="o">=</span> <span class="p">[[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s1">&#39;data-eezz-compiled&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">a_html_cells</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a_tag</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;th,td&#39;</span><span class="p">)]</span>
        <span class="n">x_html_cells</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">x_html_cells</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_html_cells</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;reference&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;row&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">x_child</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">descendends</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_child</span><span class="p">,</span> <span class="n">NavigableString</span><span class="p">):</span>
                            <span class="n">x</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">a_row</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">a_row</span><span class="o">.</span><span class="n">row_id</span><span class="p">:</span>
            <span class="n">x_fmt_attrs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_row</span><span class="o">.</span><span class="n">id</span>

        <span class="n">x_new_tag</span> <span class="o">=</span> <span class="n">Tag</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">a_tag</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">x_fmt_attrs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_html_cells</span><span class="p">:</span>
            <span class="n">x_new_tag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_new_tag</span></div>


<div class="viewcode-block" id="THttpAgent.generate_table_footer">
<a class="viewcode-back" href="../../eezz.html#eezz.http_agent.THttpAgent.generate_table_footer">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_table_footer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a_table_tag</span><span class="p">:</span> <span class="n">Tag</span><span class="p">,</span> <span class="n">a_table</span><span class="p">:</span> <span class="n">TTable</span><span class="p">,</span> <span class="n">a_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tag</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generate the table footer.</span>
<span class="sd">        Methods in this section have to be redirected to the correct table.</span>

<span class="sd">        :param bs4.Tag  a_table_tag: The HTML table template</span>
<span class="sd">        :param TTable   a_table:     The TTable object, parent for the footer to create</span>
<span class="sd">        :param str      a_id:        The new ID for method calls and references</span>
<span class="sd">        :return: The footer inner HTML</span>
<span class="sd">        :rtype:  bs4 footer TAG or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_foot_templ</span> <span class="o">=</span> <span class="n">a_table_tag</span><span class="o">.</span><span class="n">select_one</span><span class="p">(</span><span class="s1">&#39;tfoot&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">x_foot_templ</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">x_foot</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">x_foot_templ</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x_tag</span> <span class="ow">in</span> <span class="n">x_foot</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;[data-eezz-reference]&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data-eezz-reference&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;table&#39;</span><span class="p">:</span>
                <span class="n">x_tag</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">x_key</span><span class="p">:</span> <span class="n">x_val</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">a_table</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_key</span><span class="p">,</span> <span class="n">x_val</span> <span class="ow">in</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">for</span> <span class="n">x_tag</span> <span class="ow">in</span> <span class="n">x_foot</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;[data-eezz-json]&#39;</span><span class="p">):</span>
            <span class="n">x_json_str</span> <span class="o">=</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data-eezz-json&#39;</span><span class="p">)</span>
            <span class="n">x_json_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_attributes_update</span><span class="p">(</span><span class="n">x_json_str</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="n">a_id</span><span class="p">))</span>
            <span class="n">x_tag</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data-eezz-json&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_attributes</span><span class="p">(</span><span class="s1">&#39;data-eezz-json&#39;</span><span class="p">,</span> <span class="n">x_json_str</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">a_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_foot</span></div>


<div class="viewcode-block" id="THttpAgent.generate_html_table">
<a class="viewcode-back" href="../../eezz.html#eezz.http_agent.THttpAgent.generate_html_table">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_html_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a_table_tag</span><span class="p">:</span> <span class="n">Tag</span><span class="p">,</span> <span class="n">a_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generates a table structure in four steps</span>

<span class="sd">        1. Get the column order and the viewport</span>
<span class="sd">        2. Get the row templates</span>
<span class="sd">        3. Evaluate the table cells</span>
<span class="sd">        4. Send the result separated by table main elements</span>

<span class="sd">        :param  bs4.Tag a_table_tag: The parent table tag to produce the output</span>
<span class="sd">        :param  str     a_id:        Unique table ID</span>
<span class="sd">        :return: The generated table separated in sections as dictionary</span>
<span class="sd">        :rtype:  dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_table_obj</span><span class="p">:</span> <span class="n">TTable</span> <span class="o">=</span> <span class="n">TService</span><span class="p">()</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">a_id</span><span class="p">)</span>
        <span class="n">x_row_template</span> <span class="o">=</span> <span class="n">a_table_tag</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;tr[data-eezz-compiled]&#39;</span><span class="p">)</span>
        <span class="n">x_row_viewport</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x_table_obj</span><span class="o">.</span><span class="n">get_visible_rows</span><span class="p">())</span>
        <span class="n">x_table_header</span> <span class="o">=</span> <span class="n">x_table_obj</span><span class="o">.</span><span class="n">get_header_row</span><span class="p">()</span>

        <span class="c1"># insert the header, so that we could manage header and body in a single stack</span>
        <span class="n">x_row_viewport</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_table_header</span><span class="p">)</span>

        <span class="c1"># Re-arrange the cells for output</span>
        <span class="n">x_range</span>           <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_table_header</span><span class="o">.</span><span class="n">cells</span><span class="p">)))</span>
        <span class="n">x_range_cells</span>     <span class="o">=</span> <span class="p">[[</span><span class="n">x_row</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">x_range</span><span class="p">]</span> <span class="k">for</span> <span class="n">x_row</span> <span class="ow">in</span> <span class="n">x_row_viewport</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x_row</span><span class="p">,</span> <span class="n">x_cells</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_row_viewport</span><span class="p">,</span> <span class="n">x_range_cells</span><span class="p">):</span>
            <span class="n">x_row</span><span class="o">.</span><span class="n">cells</span> <span class="o">=</span> <span class="n">x_cells</span>

        <span class="c1"># Evaluate match: It&#39;s possible to have a template for each row type (header and body):</span>
        <span class="n">x_format_row</span>      <span class="o">=</span> <span class="p">[([</span><span class="n">x_tag</span> <span class="k">for</span> <span class="n">x_tag</span> <span class="ow">in</span> <span class="n">x_row_template</span> <span class="k">if</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s1">&#39;data-eezz-match&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x_tag</span><span class="p">[</span><span class="s1">&#39;data-eezz-match&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">x_row</span><span class="o">.</span><span class="n">type</span><span class="p">],</span> <span class="n">x_row</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_row</span> <span class="ow">in</span> <span class="n">x_row_viewport</span><span class="p">]</span>
        <span class="n">x_format_cell</span>     <span class="o">=</span> <span class="p">[(</span><span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">x_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;td[data-eezz-compiled],th[data-eezz-compiled]&#39;</span><span class="p">),</span> <span class="n">x_row</span><span class="o">.</span><span class="n">cells</span><span class="p">)),</span> <span class="n">x_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_row</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_tag</span><span class="p">,</span> <span class="n">x_row</span> <span class="ow">in</span> <span class="n">x_format_row</span> <span class="k">if</span> <span class="n">x_tag</span><span class="p">]</span>

        <span class="c1"># Put all together and create HTML</span>
        <span class="n">x_list_html_cells</span> <span class="o">=</span> <span class="p">[([</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_html_cells</span><span class="p">(</span><span class="n">x_tag</span><span class="p">,</span> <span class="n">x_cell</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_tag</span><span class="p">,</span> <span class="n">x_cell</span> <span class="ow">in</span> <span class="n">x_row_templates</span><span class="p">],</span> <span class="n">x_tag_tr</span><span class="p">,</span> <span class="n">x_row</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_row_templates</span><span class="p">,</span> <span class="n">x_tag_tr</span><span class="p">,</span> <span class="n">x_row</span> <span class="ow">in</span> <span class="n">x_format_cell</span><span class="p">]</span>
        <span class="n">x_list_html_rows</span>  <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_html_rows</span><span class="p">(</span><span class="n">x_html_cells</span><span class="p">,</span> <span class="n">x_tag_tr</span><span class="p">,</span> <span class="n">x_row</span><span class="p">))</span> <span class="k">for</span> <span class="n">x_html_cells</span><span class="p">,</span> <span class="n">x_tag_tr</span><span class="p">,</span> <span class="n">x_row</span> <span class="ow">in</span> <span class="n">x_list_html_cells</span><span class="p">]</span>

        <span class="n">x_footer</span>          <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_table_footer</span><span class="p">(</span><span class="n">a_table_tag</span><span class="p">,</span> <span class="n">x_table_obj</span><span class="p">,</span> <span class="n">a_id</span><span class="p">)</span>

        <span class="n">x_html</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">x_html</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">a_table_tag</span><span class="o">.</span><span class="n">prettify</span><span class="p">()</span>
        <span class="n">x_html</span><span class="p">[</span><span class="s1">&#39;caption&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">a_table_tag</span><span class="o">.</span><span class="n">caption</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">x_table_obj</span><span class="p">)</span>
        <span class="n">x_html</span><span class="p">[</span><span class="s1">&#39;thead&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_list_html_rows</span><span class="p">[:</span><span class="mi">1</span><span class="p">]])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_list_html_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">x_html</span><span class="p">[</span><span class="s1">&#39;tbody&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_list_html_rows</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_list_html_rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">x_html</span><span class="p">[</span><span class="s1">&#39;tfoot&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">x_footer</span><span class="o">.</span><span class="n">tr</span><span class="o">.</span><span class="n">prettify</span><span class="p">()</span> <span class="k">if</span> <span class="n">x_footer</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">x_html</span></div>


<div class="viewcode-block" id="THttpAgent.generate_html_grid">
<a class="viewcode-back" href="../../eezz.html#eezz.http_agent.THttpAgent.generate_html_grid">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_html_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a_tag</span><span class="p">:</span> <span class="n">Tag</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Besides the table, supported display is grid via class clzz_grid or select</span>

<span class="sd">        :param bs4.Tag a_tag:   The HTML tag, which is assigned to a TTable object</span>
<span class="sd">        :return: The DOM of the generated grid as dictionary with key &quot;tbody&quot;</span>
<span class="sd">        :rtype:  dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_row_template</span>  <span class="o">=</span> <span class="n">a_tag</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;[data-eezz-template=row]&#39;</span><span class="p">)</span>
        <span class="n">x_table</span>         <span class="o">=</span> <span class="n">TService</span><span class="p">()</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">a_tag</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="n">x_row_viewport</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x_table</span><span class="o">.</span><span class="n">get_visible_rows</span><span class="p">())</span>
        <span class="n">x_format_row</span>    <span class="o">=</span> <span class="p">[([</span><span class="n">x_tag</span> <span class="k">for</span> <span class="n">x_tag</span> <span class="ow">in</span> <span class="n">x_row_template</span> <span class="k">if</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s1">&#39;data-eezz-match&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x_tag</span><span class="p">[</span><span class="s1">&#39;data-eezz-match&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">x_row</span><span class="o">.</span><span class="n">type</span><span class="p">],</span> <span class="n">x_row</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_row</span> <span class="ow">in</span> <span class="n">x_row_viewport</span><span class="p">]</span>
        <span class="n">x_list_children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_html_grid_item</span><span class="p">(</span><span class="n">x_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_row</span><span class="p">,</span> <span class="n">x_table</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_tag</span><span class="p">,</span> <span class="n">x_row</span> <span class="ow">in</span> <span class="n">x_format_row</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;tbody&quot;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_list_children</span><span class="p">])}</span></div>


<div class="viewcode-block" id="THttpAgent.generate_html_grid_item">
<a class="viewcode-back" href="../../eezz.html#eezz.http_agent.THttpAgent.generate_html_grid_item">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_html_grid_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag_template</span><span class="p">:</span> <span class="n">Tag</span><span class="p">,</span> <span class="n">a_row</span><span class="p">:</span> <span class="n">TTableRow</span><span class="p">,</span> <span class="n">a_table</span><span class="p">:</span> <span class="n">TTable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tag</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generates elements of the same kind, derived from a template and update content</span>
<span class="sd">        according the row values</span>

<span class="sd">        :param bs4.Tag      tag_template:  Template for the entire tile</span>
<span class="sd">        :param TTableRow    a_row:         Row with data for the specific tile</span>
<span class="sd">        :param TTable       a_table:       Parent table</span>
<span class="sd">        :return: Generated HTML tag</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate name-value pairs for this row:</span>
        <span class="n">x_format_cell</span>    <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a_row</span><span class="o">.</span><span class="n">column_descr</span><span class="p">,</span> <span class="n">a_row</span><span class="o">.</span><span class="n">cells</span><span class="p">)}</span>
        <span class="n">x_new_element</span>    <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">tag_template</span><span class="p">)</span>

        <span class="c1"># Cells might split into details</span>
        <span class="k">if</span> <span class="n">x_cell_templates</span> <span class="o">:=</span> <span class="n">x_new_element</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;[data-eezz-template=cell]&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x_tag</span> <span class="ow">in</span> <span class="n">x_cell_templates</span><span class="p">:</span>
                <span class="n">x_ref</span>    <span class="o">=</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data-eezz-reference&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">x_cell</span>   <span class="o">=</span> <span class="n">x_format_cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">x_cell</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no reference to </span><span class="si">{</span><span class="n">x_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Cells details part and continue.</span>
                <span class="c1"># Detail tags have to be generated from template. The template will be removed as a last step</span>
                <span class="n">x_cell</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">a_row</span><span class="o">.</span><span class="n">row_id</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_ref</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">x_ref</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;detail&#39;</span><span class="p">:</span>
                    <span class="n">x_templates</span> <span class="o">=</span> <span class="p">[(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">x_tag</span><span class="p">),</span> <span class="n">detail</span><span class="p">)</span> <span class="k">for</span> <span class="n">detail</span> <span class="ow">in</span> <span class="n">x_cell</span><span class="o">.</span><span class="n">details</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">x_cnt</span><span class="p">,</span> <span class="n">x_item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_templates</span><span class="p">):</span>
                        <span class="n">x_template</span><span class="p">,</span> <span class="n">x_detail</span> <span class="o">=</span> <span class="n">x_item</span>
                        <span class="n">x_detail</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">x_cnt</span>
                        <span class="n">x_template</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">a_table</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">a_row</span><span class="o">.</span><span class="n">row_id</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">x_cell</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">x_cnt</span><span class="si">}</span><span class="s1">&#39;</span>

                        <span class="n">x_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">x_key</span><span class="p">:</span> <span class="n">x_val</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="n">x_detail</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_key</span><span class="p">,</span> <span class="n">x_val</span> <span class="ow">in</span> <span class="n">x_template</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x_key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;data-eezz&#39;</span><span class="p">)}</span>
                        <span class="k">if</span> <span class="n">x_json_str</span> <span class="o">:=</span> <span class="n">x_template</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data-eezz-json&#39;</span><span class="p">):</span>
                            <span class="n">x_template</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data-eezz-json&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_attributes_update</span><span class="p">(</span><span class="n">x_json_str</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="n">x_detail</span><span class="p">))</span>
                        <span class="n">x_template</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x_attrs</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">x_template</span><span class="o">.</span><span class="n">string</span><span class="p">:</span>
                            <span class="n">x_template</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">x_template</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="n">x_detail</span><span class="p">)</span>
                        <span class="n">x_tag</span><span class="o">.</span><span class="n">insert_before</span><span class="p">(</span><span class="n">x_template</span><span class="p">)</span>
                    <span class="n">x_tag</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span>
                    <span class="k">continue</span>

                <span class="c1"># Cells main part</span>
                <span class="c1"># Generate unique ID, format call parameter, attributes and strings</span>
                <span class="n">x_cell</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">a_row</span><span class="o">.</span><span class="n">row_id</span>
                <span class="n">x_attrs</span>   <span class="o">=</span> <span class="p">{</span><span class="n">x_key</span><span class="p">:</span> <span class="n">x_val</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">x_cell</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_key</span><span class="p">,</span> <span class="n">x_val</span> <span class="ow">in</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x_key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;data-eezz&#39;</span><span class="p">)}</span>
                <span class="k">if</span> <span class="n">x_json_str</span> <span class="o">:=</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data-eezz-json&#39;</span><span class="p">):</span>
                    <span class="n">x_tag</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data-eezz-json&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_attributes_update</span><span class="p">(</span><span class="n">x_json_str</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">x_cell</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">x_json_str</span> <span class="o">:=</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data-eezz-i18n&#39;</span><span class="p">):</span>
                    <span class="n">x_tag</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data-eezz-i18n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_json_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">x_cell</span><span class="p">)</span>

                <span class="n">x_tag</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x_attrs</span><span class="p">)</span>

                <span class="n">x_tag</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data-eezz-index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x_cell</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">x_tag</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">a_table</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">a_row</span><span class="o">.</span><span class="n">row_id</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">x_cell</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">if</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">string</span><span class="p">:</span>
                    <span class="n">x_tag</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">x_cell</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">x_format</span> <span class="o">:=</span> <span class="n">x_tag</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data-eezz-format&#39;</span><span class="p">):</span>
                        <span class="n">x_html</span>  <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;p&gt;</span><span class="si">{</span><span class="n">x_format</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x_tag</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">))</span><span class="si">}</span><span class="s1">&lt;/p&gt;&#39;</span>
                        <span class="n">x_soup</span>  <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">x_html</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
                        <span class="n">x_tag</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">x_tag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_soup</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x_new_element</span></div>
</div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;:meta private:&quot;&quot;&quot;</span>
    <span class="n">text2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;table id=&#39;directory&#39; data-eezz=&#39;name: directory, assign: examples.directory.TDirView(path=&quot;.&quot;, title=&quot;dir&quot;)&#39;&gt;</span>
<span class="s2">        &lt;tbody&gt;</span>
<span class="s2">            &lt;tr data-eezz=&#39;template: row, match: body,</span>
<span class="s2">                event  : expand_collapse(rowid=</span><span class="si">{row.row_id}</span><span class="s2">),</span>
<span class="s2">                update : this.subtree=restricted, path_label.innerHTML=</span><span class="si">{row.row_id}</span><span class="s2">&#39;&gt;</span>
<span class="s2">            &lt;/tr&gt;</span>
<span class="s2">        &lt;/tbody&gt;</span>
<span class="s2">    &lt;/table&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># list_table = aSoup.css.select(&#39;table[data-eezz]&#39;)</span>
    <span class="n">TService</span><span class="o">.</span><span class="n">set_environment</span><span class="p">(</span><span class="n">root_path</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;C:\Users\alzer\Projects\github\eezz_full\webroot&#39;</span><span class="p">)</span>
    <span class="n">xx_gen</span>    <span class="o">=</span> <span class="n">THttpAgent</span><span class="p">()</span>
    <span class="n">xx_html</span>   <span class="o">=</span> <span class="n">xx_gen</span><span class="o">.</span><span class="n">do_get</span><span class="p">(</span><span class="n">text2</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>
    <span class="n">xx_soup</span>   <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">xx_html</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">,</span> <span class="n">multi_valued_attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># xx_h1_set = xx_soup.css.select(&#39;h1&#39;)</span>
    <span class="c1"># xx_h1     = xx_h1_set[0]</span>
    <span class="c1"># xx_str    = xx_h1.string</span>
    <span class="c1"># print(xx_str.parent)</span>

    <span class="n">list_table</span> <span class="o">=</span> <span class="n">xx_soup</span><span class="o">.</span><span class="n">css</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">list_table</span><span class="p">:</span>
        <span class="n">xjsn</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[</span><span class="s1">&#39;data-eezz&#39;</span><span class="p">]</span>
        <span class="c1"># json.loads( f&#39;{{ {xjsn} }}&#39; )</span>
        <span class="c1"># xjsn[&#39;assign&#39;] = &#39;new values for subtree&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="s1"> </span><span class="si">{</span><span class="n">xjsn</span><span class="si">}</span><span class="s1"> </span><span class="se">}}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">xx_table</span>  <span class="o">=</span> <span class="n">xx_gen</span><span class="o">.</span><span class="n">generate_html_table</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">xx</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="n">debug_out</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">xx_table</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">debug_out</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">debug_out</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;done&#39;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Albert Zedlitz.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>